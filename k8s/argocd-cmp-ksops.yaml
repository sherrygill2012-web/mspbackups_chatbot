# ArgoCD Config Management Plugin for KSOPS
# This creates a sidecar container that handles SOPS-encrypted secrets
apiVersion: v1
kind: ConfigMap
metadata:
  name: cmp-plugin
  namespace: argocd
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: ksops
    spec:
      version: v1.0
      init:
        command: ["/bin/sh", "-c"]
        args:
          - |
            # Set up ksops plugin for kustomize in /tmp (writable)
            mkdir -p /tmp/kustomize/plugin/viaduct.ai/v1/ksops
            cp /usr/local/bin/ksops /tmp/kustomize/plugin/viaduct.ai/v1/ksops/ksops
      generate:
        command: ["/bin/sh", "-c"]
        args:
          - |
            export XDG_CONFIG_HOME=/tmp
            export KUSTOMIZE_PLUGIN_HOME=/tmp/kustomize/plugin
            /usr/local/bin/kustomize build --enable-alpha-plugins .

